---
title: "第2-4天：Monorepo迁移冲刺（3天111次Commit）"
date: "2026-01-24"
summary: "盘盘猫开发日记第2-4天：CSS修复地狱、共享包提取、新增MBTI应用、微信浏览器检测，以及统一API层完成52条路由迁移。"
tags: ["AI", "Software Development"]
series: "盘盘猫开发日记"
part: 2
type: "Post"
status: "Published"
---

三天。111次commit。我敢说其中一半的commit message都写着"fix css"。

## 第2天：CSS修复地狱 — 38次Commit

当我把Tailwind配置统一到`packages/config`之后，每一个依赖自定义design token的应用都崩了。不是那种明显的"红色报错页面"式崩溃，而是那种微妙的"背景颜色好像不太对，为什么那个按钮小了2px"式崩溃。

问题在于：每个应用进化出了自己的CSS变量命名空间。八字用`--bz-*`系列token，塔罗用`--tarot-*`，占星用`--zx-*`。统一Tailwind配置意味着这些都得共存且不能冲突，同时每个应用还要保持自己的视觉风格。

38次commit。每一次都在修我之前漏掉的CSS问题。但到最后，我也同时提取了4个新的共享包：PDF生成、聊天记录、共享聊天UI、以及通用React hooks。

包的提取才是真正的收获。三个应用各自有自己的`ChatPanel`组件，实现略有不同。三个应用各自有PDF导出代码，用的都是同样的html2canvas流程。把这些提取到`packages/ui`和`packages/pdf`，意味着一处修复，处处生效。

## 第3天：第6个应用和微信检测 — 17次Commit

新增了MBTI人格测试作为第六个应用。集成起来更轻松，因为一开始就知道它要进monorepo——从第一天就用上了共享包。

更有意思的挑战是微信浏览器检测。中国互联网流量中有相当大的比例是通过微信内置浏览器产生的，而这个浏览器有各种坑：有限的`getUserMedia`支持、不同的OAuth流程要求、受限的`window.open`行为。UA嗅探需要检查Android、iOS和桌面端各版本中的`MicroMessenger`，还有企业微信变体（`wxwork`）。

后来（PR #41），当真实设备暴露了漏检问题时，这个检测又做了一次加固——某些微信版本嵌入的UA字符串和文档记载的不一样。

## 第4天：大日子 — 56次Commit

### 统一API包

整个项目最大的架构胜利。`packages/api`标准化了所有应用与AI模型通信的方式。

之前：每个应用都有自己的流式路由，大约80行样板代码用于`ReadableStream`设置、SSE事件格式化、错误处理和积分扣减。重复了15次以上。

之后：`createAIStreamResponse()` — 一个工具函数，接收一个带有生命周期钩子的配置对象：

- `initEvents` — 在AI流式传输开始前发送初始数据

- `onComplete` — 保存结果、记录费用

- `onError` — 优雅地处理失败

- `refundCreditsOnError` — 流中断时自动退还积分

52条API路由迁移到了这个模式。Claude Code通过看一个示例就能把它应用到其余所有路由。实际耗时大约一小时，手动做的话至少要整整一天。

### 内容过滤器v1

同样在第4天完成：基于DFA的敏感词过滤器。这对中国市场至关重要。玄学内容天然包含一些会触发简单关键词过滤的词——算命、破财、桃花劫。一个标准的敏感词过滤器会把我们一半的正常内容都屏蔽掉。

DFA（确定性有限自动机）的方法是从词表构建一棵trie树，然后逐字符扫描文本。这个版本会直接屏蔽包含敏感词的整条消息——后续迭代会变得更加精细。

### GDPR和法律合规

搞定了中英双语的服务条款和隐私政策。不光鲜，但必须做。后来（PR #83）又进行了全面重写，分成了独立的中文版和英文版，并加入了中国AI监管合规条款。

### 那个瞬间

大约晚上11点，我在本地同时启动了6个应用，用同一个账号登录，看着积分在各个标签页之间实时同步。一次登录。一个积分余额。六个产品。它真的跑起来了。

三天前我还有5个独立应用。现在我有了一个平台。
