---
title: "第12-19天：积分经济、新功能与功能爆发"
date: "2026-02-08"
summary: "盘盘猫开发日记第12-19天：邀请返利系统、基于MediaPipe的掌纹识别、落地页暗黑奢华风重设计，以及一个领悟——工程不再是瓶颈了。"
tags: ["AI", "Software Development"]
series: "盘盘猫开发日记"
part: 4
type: "Post"
status: "Published"
---

这一周，PanPanMao从"有意思的原型"变成了"拥有多条产品线、可运转的经济系统和让我真正自豪的视觉风格的平台"。

## 第12-14天：积分经济动真格了

### 邀请返利系统

每个用户都有唯一的邀请码。邀请人获得奖励积分，被邀请人获得欢迎奖励。听起来简单。一个数据背后是三层实现：

1. **URL参数** — `?ref=PPM-XXXX-XXXX`，在落地页捕获

1. **localStorage兜底** — 在注册流程中持久化邀请码（用户可能先逛逛再注册）

1. **服务端校验** — Supabase RPC `claim_referral_bonus()`，包含最大邀请限制、竞态条件防护和反作弊检测

返利金额经历了真实的产品迭代。最初是非对称的（邀请人10积分，被邀请人3积分）。用户觉得有被"薅"的感觉——"我是在利用朋友来赚积分"。改成对称的（各5积分）后，邀请量反而上升了。激励机制的设计比看上去难多了。

PR #59后来修复了一个bug：`link_referral()`拒绝了有效的新用户，因为它在用户还没有任何使用记录之前就检查了`usage_log`。那个防护逻辑在防一件根本还不可能发生的事。

### 用户资料和引导流程

PR #41是一次重大的体验改版：可编辑的用户资料字段（姓名、性别、生日、出生时辰、出生地、语言偏好），一个全局引导弹窗在用户认证后强制完善资料，以及一个"一键带入我的出生资料"按钮，可以自动填充八字、占星和K线输入表单。

语言优先级系统设计得很细致：已登录用户的`localePreference`覆盖浏览器语言，但语言切换器会同步回用户资料。匿名用户只走浏览器检测。

## 第16-19天：打造相术 — 掌纹和面相识别

整个项目中技术难度最高的功能。PR #1：56个文件变更，新增6,881行代码，15次commit。

### 浏览器端MediaPipe机器学习

检测流水线完全在客户端运行。计算机视觉部分不需要服务端往返：

- **`useMediaPipeLoader`** — WASM懒加载（约3MB二进制文件），模块级缓存。首次加载较慢，后续加载即时完成。

- **`useFaceDetector`** — BlazeFace模型，在摄像头预览时以60fps运行。给用户实时反馈——摄像头能识别到你的脸。

- **`useFaceLandmarker`** — 478点面部网格。只在拍照后运行一次。提取三停、五官、十二宫位的测量数据。

- **`useHandLandmarker`** — 21点手部骨架。识别三大主线、辅助线和掌丘位置。

- **`useCameraCapture`** — `getUserMedia`调用，8秒超时以兼容移动端浏览器。

实时覆盖层效果：掌纹上的绿色标记点，面部特征上的网格。在视频画面上叠加Canvas层，移动端隔帧渲染以保持可用的帧率。

PR #35后来为掌纹检测增加了GPU→CPU回退。有些设备的WebGL支持报告为可用，但在推理时实际会失败。回退机制会检测到失败并用纯CPU模式重试。PR #50把所有WASM文件和模型文件本地化到了应用自身的静态资源目录，因为中国用户无法稳定访问[cdn.jsdelivr.net](http://cdn.jsdelivr.net/)。

### 多模态AI解读

拍摄的图片通过多模态prompt发送给Claude或Gemini。但"看看这个掌纹"只会产出泛泛的结果。prompt设计了四个层次：

1. **角色定义** — 你是一位拥有30年经验的中国相术大师

1. **知识注入** — 五官、三停、十二宫位、脸型、掌纹含义、掌丘解读规则

1. **交叉验证** — 用多个相术体系对照检验你的分析

1. **结构化输出** — 指定段落结构、置信度、可操作的建议

30个领域测试验证知识包的正确性。prompt模板会根据性别条件注入特定知识：女性用户会获得额外的旺夫/克夫分析、柳庄四件解读、以及女性特有的掌纹特征分析。

从零到上线，四天。每项能力单独来看都是近年的新技术——浏览器端ML、多模态大模型、结构化AI输出——但把它们组合在一起，创造出的东西真的有一种魔法般的感觉。

## 落地页重新设计

暖棕金色的主题不好使了。产品越来越正经——用户带着关于事业、感情、健康的真实问题来找答案。"温馨"削弱了庄重感。

重新设计为暗黑奢华风。深邃的黑色。金色点缀。猫从可爱的吉祥物变成了神秘的预言者。用户的反馈是"值得信赖"和"专业"。同样的产品，不同的定位，截然不同的感知。

## 阶段性数据

到第19天：7条产品线、运转中的积分经济、邀请返利系统、暗黑奢华风落地页、浏览器端掌纹/面相识别。大约700次commit。

瓶颈翻转了。不再是工程了，而是产品决策。下一步做什么。怎么定位。收多少钱。工程能力跟得上我的任何决定——难的是做出正确的决定。
