---
title: "第20-23天：四天内交付M1、M2、M3三个里程碑"
date: "2026-02-12"
summary: "盘盘猫开发日记第20-23天：166次commit，3个正式里程碑，17个PR。积分经济体系基础、每日运势Hub预生成内容架构、PostHog数据分析接入。"
tags: ["AI", "Software Development"]
series: "盘盘猫开发日记"
part: 5
type: "Post"
status: "Published"
---

四天，166次commit。三个正式里程碑交付。17个PR合并。这是项目从"做功能"转向"做生意"的关键阶段。

## 里程碑框架

我引入了里程碑的概念——每个里程碑是一个完整的、可交付的增量，有明确的前后状态对比。同时开始认真使用PR。一个人开发还写PR听起来有点傻，但PR其实有三个实际作用：记录意图、提供可对比的变更历史、以及强迫自己想清楚"到底在交付什么、为什么要做"。

每个PR都有结构化的描述：摘要、变更表格、带复选框的测试计划。这种纪律在三周后你需要理解"当时为什么要改这个"的时候，回报是实实在在的。

## M1：积分经济体系基础（PR #2 — 100个文件变更）

从"免费产品"到"免费试用+付费选项"的转变。其中最难的技术挑战：

### 匿名用户到注册用户的合并

新用户以Supabase匿名用户的身份开始使用——零注册摩擦。他们可以浏览、使用免费积分、保存测算结果。当他们之后选择登录（Google OAuth、邮箱、或兑换码），所有数据都需要合并：积分余额、保存的测算、聊天记录、推荐关系。

兑换码流程是一个状态机：`idle → checking → redeeming/logging_in → success/error`。`RedeemCodeInput`组件自动格式化`PPM-XXXX-XXXX`输入，处理完整的生命周期。当匿名用户输入兑换码时，后端会把兑换码设置为他们匿名账户的密码——兑换码本身就是他们下次登录的凭证。

PR #103后来修复了一个竞态条件：`liunian`应用类型在`llm_costs_app_check`约束中缺失，导致用户使用流年运程功能时在生产环境中INSERT失败。

### 跨标签页积分同步

Bug：在一个标签页买了积分，切换到另一个标签页，看到的还是旧余额，以为购买失败了，又买了一次。双重扣费。

解决方案：Supabase实时订阅。每个标签页都订阅用户的积分变动。当一个标签页扣除或增加积分时，其他所有标签页在一秒内同步更新。听起来简单，但要把订阅生命周期做对（挂载时订阅、卸载时取消、标签页休眠后重连）需要精细的状态管理。

### 7种场景化升级提示

`UpgradePrompt`组件有7种触发类型，每种都针对特定的情感时刻：

- 测算过程中积分用完（高紧迫感，高购买意愿）

- 每日运势Hub浏览时余额不足（低紧迫感，意识培养）

- 测算完成后的满足时刻（正面情绪，追加销售）

- 推荐提示（社交场景，"送礼"的框架）

- 首次发现新功能（好奇心驱动，试用转付费）

还有卡片和横幅两种变体，以及24小时的关闭冷却期，避免用户觉得被骚扰。

## M2：每日运势Hub（PR #4 — 100个文件变更）

用户粘性架构。算命本质上是事件驱动的：用户有问题了才来，得到答案就走。每日运势Hub给了用户一个每天回来的理由。

五张卡片：八字日柱运势、星座运势、每日塔罗牌、黄历、占卜引导。每张都有自定义的CSS主题样式。

### 预生成架构

关键决策：**北京时间午夜通过cron定时任务生成内容，而不是按需生成。** `/api/cron/daily-content`端点通过Gemini AI生成八字和星座运势，存储到`daily_content`表中，自动清理7天前的数据。

用户早上8点打开Hub，内容已经在那了。瞬间加载。没有loading。即时加载和3秒等待之间感知到的质量差异是巨大的。这是一个伪装成架构决策的产品洞察。

cron端点使用常量时间XOR进行密钥比较（安全审计发现的问题），基于IP的频率限制（30次/分钟），以及Asia/Shanghai时区的一致性处理。

### 占星（Zhanxing）模块重构

也在这个PR中：占星模块的完整国际化重构。一个347行的三语字典（zh-CN/zh-TW/en），涵盖行星、星座、相位、宫位，以及70多个结果页面字符串。星盘轮盘重新设计为金色-暗色主题风格，带有度数刻度线、中文行星/星座标签和交互式提示框。78个测试覆盖星盘计算和布局函数。

### 合盘（Synastry）持久化

新增`synastry_readings`表，包含加密的出生信息、完整的保存/加载/聊天流程，以及历史记录API集成。出生数据加密是安全需求——合盘测算包含两个人的出生信息。

## M3：分发（PR #10 — 11个文件变更）

PostHog集成。使用`after()`进行兑换码事件追踪，避免阻塞兑换响应。清理了被管理后台取代的旧管理路由。

PR规模最小，但它闭合了反馈环路：现在我能看到用户实际做了什么，而不是我以为他们做了什么。

## 思维的转变

M1-M3之前："下一个该做什么功能？"

M1-M3之后："下一步该驱动什么用户行为？"

转化漏斗。留存钩子。日活参与。推荐激励。这些不是工程问题。这些是恰好需要工程手段来解决的商业问题。这是我第一次开始思考用户留存，而不是功能清单。
