---
title: "第27天：98次Commit，三个新产品上线"
date: "2026-02-15"
summary: "盘盘猫开发日记第27天：最高产的一天。98次commit。三个新产品（起名、配对、流年运程）从零到上线。"
tags: ["AI", "Software Development"]
series: "盘盘猫开发日记"
part: 6
type: "Post"
status: "Published"
---

98次commit。一天。三个全新产品从零到上线。加上让这种速度成为可能的重构和基础设施工作。这是整个项目中生产力最高的一天。

## 让速度成为可能的重构

在能这么快地交付新产品之前，两个重构必须先落地：

### 标准化15个流式路由（PR #16）

15个API路由从自定义的`ReadableStream`实现迁移到共享的`createAIStreamResponse()`辅助函数。24个文件变更，约1,600行新增，约2,000行删除——**净减少400行**。辅助函数加入了生命周期钩子：`initEvents`、`onComplete`、`onError`、`refundCreditsOnError`。

有三个路由确实需要自定义流式处理：MBTI聊天（累积缓冲区差量模式，用于从用户可见文本中剥离内部信号标记）、梦境长篇解析（多步骤生成协议）、以及每日运势（非流式，带服务端缓存）。

36个新测试。`@panpanmao/api`共计173个测试。

### 集中化成本日志（PR #21）

每个流式路由都有相同的样板代码：创建一个cost logger，用`as never`类型断言插入记录（绕过Supabase的类型限制）。PR #21用`createRouteCostLogger()`替换了20个文件中的这个模式——把Supabase类型绕过方案集中到一处，而不是到处复制。1,942个测试通过。

这两个重构把"新增一个AI功能"的模板代码从每个路由约80行降到了约15行。

## 三个新产品

### AI起名

中国人给孩子起名是很认真的事。名字要关联八字五行（五行平衡）、笔画吉凶（笔画数理）、以及家族起名规则。家长们会找起名大师（一次200-2000元）。

AI的实现方式：根据出生数据计算孩子的五行格局，找出需要加强或平衡的元素，生成每个字的五行属性、笔画数、音韵质量和语义含义都对齐的名字。领域知识包里有字-五行映射表、笔画数据库和起名规则。

从零到上线大约4小时。快的部分不是AI——是基础设施。认证、积分、流式传输、错误处理、内容过滤、历史保存都来自共享包。唯一新写的代码是领域知识和UI。

### 配对分析

根据两个人的姓名和出生信息分析缘分。五行相生相克评分、日柱和合分析、字级五行互动。结果可分享——这是算命最常见的使用场景：感情问题。

### 流年运程（PR #85）

三个产品中最重量级的。一个全新的领域模块：`domains/liunian/`，包含计算器（生肖、太岁分析、流年飞星、五行年运）、知识数据包（星曜目录、星曜-年份映射、太岁冲犯规则、生肖性格画像）、以及AI提示词模板。

48个文件变更。162个领域测试通过。前端采用渐进式渲染：太岁横幅和流年飞星通过计算即时展示，然后AI运势内容通过SSE逐步流式呈现。

PR #96后来修复了一个微妙的SSE解析bug：liunian的hook在主读取循环中只解析以换行符结尾的完整帧。当最后的帧作为尾部缓冲数据到达时（一个`chunk` + `done`但没有尾部换行），hook丢弃了`done`事件，显示了一个误导性的网络错误，实际上解读已经完成了。修复方案：在终结化阶段刷新decoder状态并解析尾部缓冲的SSE事件。

## 中国城市Bug

同一天，PR #34修复了一个用户报告的bug：八字的城市搜索只有46个中国主要城市。搜索黔西南、黔东南（贵州的自治州）的用户没有结果。修复方案是将数据库从**46扩展到379条**，覆盖全部333个地级行政区划（地级市/自治州/盟/地区）。每条记录包含经纬度、省份和用于简称匹配的别名。5个新的地理编码测试。

这种bug，如果你的测试用户全在北京上海，是完全看不见的。

## Agentic工作流

Git历史中散布着`claude/`和`codex/`分支。工作流程是这样的：

1. 我描述产品概念和需求

1. Claude Code按照已有的`createAIStreamResponse()`模式创建API端点

1. 另一个session用共享组件库构建UI组件

1. 我review、调整领域特定的prompt（这部分一定是手动的），然后merge

1. 集成测试、积分消耗注册、Hub卡片创建

1. 部署

到第三个产品时，这个流程已经近乎机械化了。好架构的复利效应：前几个产品很难做，后面每个新产品都变得显著更容易。

**保守估计：今天95%的代码是AI生成的。** 我负责产品决策、review输出、编写领域特定的prompt、以及处理集成。AI写实现。但我写的那5%——prompt、产品决策、集成胶水代码——才是让它成为产品而不是demo的关键。

## 思考

98次commit大约是15小时里每9分钟一次。这种速度长期来看不可持续。但即使是一半的速度，一天三个新产品——有真实的业务逻辑、真实的AI集成、真实的积分经济、真实的数据持久化——这不是"快速行动打破一切"，这是因为地基够扎实所以才能跑这么快。

产品数量：9个垂直方向。而我到现在还是不会看手相。
